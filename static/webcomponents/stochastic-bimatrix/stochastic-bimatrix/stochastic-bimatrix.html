<link rel="import" href="/static/bower_components/polymer/polymer.html">

<link rel="import" href="/static/otree-redwood/webcomponents/otree-constants/otree-constants.html">
<link rel="import" href="/static/otree-redwood/webcomponents/otree-continuous-decision/otree-continuous-decision.html">

<link rel="import" href="/static/webcomponents/stochastic-bimatrix/bimatrix-heatmap/bimatrix-heatmap.html">
<link rel="import" href="/static/webcomponents/stochastic-bimatrix/otree-thermometer/otree-thermometer.html">
<link rel="import" href="/static/webcomponents/stochastic-bimatrix/payoff-graph/payoff-graph.html">
<link rel="import" href="/static/webcomponents/stochastic-bimatrix/strategy-graph/strategy-graph.html">

<dom-module id="stochastic-bimatrix">
    <template>
        <style>
            :host { margin: 10px; }

            #slider {
                writing-mode: bt-lr; /* IE */
                -webkit-appearance: slider-vertical; /* WebKit */
                width: 8px;
                height: 310px;
                margin: 25px 0 0 -30px;
            }
        </style>

        <otree-constants id="constants"></otree-constants>
<<<<<<< HEAD:_static/webcomponents/app/stochastic-bimatrix/stochastic-bimatrix.html
        <otree-continuous-decision
            component="stochastic-bimatrix"
            group-decisions="{{ decisions }}">
        </otree-continuous-decision>

        <div style="height: 570px">
            
            <div style="float:left; padding-left: 40px">
                <bimatrix-heatmap
                    width='120'
                    height='120'
                    my-decision='[[other_decision]]'
                    other-decision='[[my_decision]]'
                    payoffs='[[other_payoffs_transpose]]'
                    color='[[other_color]]'
                ></bimatrix-heatmap>
                <div style="float:left">
                    <input id="slider" type="range" min="0" max="1" step=".01" value="[[my_decision]]" on-up="_setMyDecision" />
                </div>
                <div style="float:right">
                    <bimatrix-heatmap
                        class="heatmap"
                        width='300'
                        height='300'
                        my-decision='[[my_decision]]'
                        other-decision='[[other_decision]]'
                        payoffs='[[my_payoffs]]'
                        color='[[my_color]]'
                    ></bimatrix-heatmap>
                </div>
            </div>

            <div style="float:right">
                <strategy-graph
=======
        <otree-log id="log"></otree-log>
        <firebase-document
            id="fbdoc"
            path="[[path_]]"
            data="{{ decisions }}">
        </firebase-document>

        <div style="padding-left: 40px; padding-right: 40px;">
            <div style="height:50px;text-align:center;">
                <span style="float:left">Your Payoffs</span>
                <span>Payoff over time graph</span>
                <span style="float:right">Opponent's Payoffs</span>
            </div>
            <div style="height: 250px">
                <otree-heatmap
                    style="float:left"
                    width='150'
                    height='150'
                    my-decision='[[my_decision]]'
                    other-decision='[[other_decision]]'
                    payoffs='[[my_payoffs_B]]'
                    color='gray'
                ></otree-heatmap>
                <otree-payoff-graph
                    style="position:absolute;left:calc(50% - 275px);"
>>>>>>> b75b8cbb004ed064758b4265b8d73523f709aacd:_static/webcomponents/smart/otree-stochastic-bimatrix/otree-stochastic-bimatrix.html
                    my-decision='[[my_decision]]'
                    other-decision='[[other_decision]]'
                    my-payoffs='[[my_payoffs_A]]'
                    other-payoffs='[[other_payoffs_A]]'
                    period-length='120'
<<<<<<< HEAD:_static/webcomponents/app/stochastic-bimatrix/stochastic-bimatrix.html
                ></strategy-graph>
                <div style="float:left">
                    <!--<otree-thermometer color='rainbow'></otree-thermometer>-->
                </div>
                <div style="float: right">
                    <payoff-graph
                        my-decision='[[my_decision]]'
                        other-decision='[[other_decision]]'
                        my-payoffs='[[my_payoffs]]'
                        other-payoffs='[[other_payoffs]]'
                        period-length='120'
                    ></payoff-graph>
                </div>
=======
                ></otree-payoff-graph>
                <otree-heatmap
                    style="float:right"
                    width='150'
                    height='150'
                    my-decision='[[my_decision]]'
                    other-decision='[[other_decision]]'
                    payoffs='[[other_payoffs_B]]'
                    color='gray'
                ></otree-heatmap>
            </div>
            <div style="height: 400px">
                <input id="slider" style="float:left" type="range" min="0" max="1" step=".01" value="[[my_decision]]" on-up="_setMyDecision" />
                <otree-heatmap
                    style="float:left"
                    width='300'
                    height='300'
                    my-decision='[[my_decision]]'
                    other-decision='[[other_decision]]'
                    payoffs='[[my_payoffs_A]]'
                    color='[[my_color]]'
                ></otree-heatmap>
                <button
                    style="position:relative;left:calc(50% - 300px - 80px);top:50px"
                    on-click="_switchMatrix"
                >Switch Payoff Matrices</button>
                <otree-heatmap
                    style="float:right"
                    width='300'
                    height='300'
                    my-decision='[[my_decision]]'
                    other-decision='[[other_decision]]'
                    payoffs='[[other_payoffs_A]]'
                    color='[[other_color]]'
                ></otree-heatmap>
>>>>>>> b75b8cbb004ed064758b4265b8d73523f709aacd:_static/webcomponents/smart/otree-stochastic-bimatrix/otree-stochastic-bimatrix.html
            </div>
        </div>
    </template>

    <script src="/static/general/color.js"></script>

    <script>
        Polymer({
            is: 'stochastic-bimatrix',
            properties: {
                payoffMatrices: Array,
                decisions: {
                    type: Object,
                    observer: '_decisionsChanged'
                },
                periodLength: Number
            },
            listeners: {
                keyup: '_setMyDecision'
            },
            ready() {
<<<<<<< HEAD:_static/webcomponents/app/stochastic-bimatrix/stochastic-bimatrix.html
=======
                this.path_ = (
                    '/session/' + this.$.constants.session +
                    '/app/' + this.$.constants.appName +
                    '/subsession/' + this.$.constants.subsession +
                    '/round/' + this.$.constants.round +
                    '/group/' + this.$.constants.group +
                    '/component/otree-bimatrix' +
                    '/decisions'
                )

>>>>>>> b75b8cbb004ed064758b4265b8d73523f709aacd:_static/webcomponents/smart/otree-stochastic-bimatrix/otree-stochastic-bimatrix.html
                // set payoff indices
                if (this.$.constants.idInGroup == undefined) {
                    console.log('Not in game, manually setting payoffIndex')
                    this.payoffIndex = 0
                } else {
                    this.payoffIndex = this.$.constants.idInGroup - 1
                }
                this.otherPayoffIndex = 1 - this.payoffIndex

                // variables for this player's decision and the opponent's decision
                this.my_decision = .5
                this.other_decision = .5

                // variable for which matrix is in use
                this.matrix_index = 1

                // color schemes for each player's heatmaps
                this.my_color = 'rainbow'
                this.other_color = 'mono'

                this._calcPayoffs()
            },
            _calcPayoffs() {
                // some function of decisions determines which payoff matrix will be used
                if (this.my_decision == undefined)
                    return
                // get two matrix indices
                const index_A = this.matrix_index
                const index_B = 1 - index_A
                // get four payoff matrices
                this.my_payoffs_A = this.payoffMatrices[index_A].map(val => parseInt(val[this.payoffIndex]))
                this.other_payoffs_A = this.payoffMatrices[index_A].map(val => parseInt(val[this.otherPayoffIndex]))
                this.my_payoffs_B = this.payoffMatrices[index_B].map(val => parseInt(val[this.payoffIndex]))
                this.other_payoffs_B = this.payoffMatrices[index_B].map(val => parseInt(val[this.otherPayoffIndex]))
            },
            // set my current decision. triggered by the player releasing the slider
            _setMyDecision(event) {
                if (event.type === 'keyup' && !(event.key === 'ArrowDown') && !(event.key === 'ArrowUp'))
                    return

                const d = parseFloat(event.target.value)
                // if decisions hasn't been created yet, create it
                this.decisions = this.decisions || {}
                // pcode is this player's participant code
                const pcode = this.$.constants.participantCode
                // use polymer this.set to change decisions. I don't really know why I have to do this but it doesn't work if I don't
                this.set('decisions.' + pcode, d)
                this.my_decision = d
            },
            // listener on firebase decisions array. reacts to the opponent changing their strategy
            _decisionsChanged() {
                if (this.decisions === null)
                    return

                const pcode = this.$.constants.participantCode
                // if I haven't set a decision yet, use my decision from firebase. here in case someone refreshes the page
                if (this.decisions[pcode])
                    this.my_decision = this.decisions[pcode]

                // get other player's decision by picking the key that isn't yours
                // there's probably a better way of doing this
                for (let key in this.decisions) {
                    if (key != pcode) {
                        this.other_decision = this.decisions[key]
                        break
                    }
                }
                this._calcPayoffs()
            },
            // handle switch-matrix button pressed
            _switchMatrix(event) {
                event.preventDefault()
                this.matrix_index = 1 - this.matrix_index
                this._calcPayoffs()
            }
        })
    </script>
</dom-module>
